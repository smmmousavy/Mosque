<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosque Weekly Task Scheduler</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fbf8;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 sm:p-8">
        <!-- Header -->
        <header class="text-center py-6 bg-white shadow-lg rounded-xl mb-8">
            <!-- Updated Title -->
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Weekly Task Assignments for Doa Komeil</h1>
            <p class="text-lg text-gray-600 mt-2">Sign up for a task for the upcoming four Thursdays.</p>
            
            <!-- Name Input & Display -->
            <div id="auth-status" class="mt-4 flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <div id="name-input-container" class="flex space-x-2 hidden">
                    <input type="text" id="name-input" placeholder="Enter your name" class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-gray-700 w-40 sm:w-auto shadow-sm">
                    <button id="set-name-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition font-semibold">
                        Set Name
                    </button>
                </div>
                <p id="user-display" class="text-base font-medium text-gray-700 hidden"></p>
                <button id="change-name-btn" class="text-sm text-blue-500 hover:text-blue-700 transition hidden">Change Name</button>
            </div>
        </header>

        <!-- Loading & Error Indicator -->
        <div id="status-message" class="hidden text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg mb-6">
            Connecting to database...
        </div>

        <!-- Weeks Navigation -->
        <div id="weeks-nav" class="flex justify-center flex-wrap mb-8 space-x-2 sm:space-x-4">
            <!-- Navigation buttons will be inserted here by JavaScript -->
        </div>

        <!-- Task Tables Container -->
        <div id="weeks-container" class="space-y-8">
            <!-- Weekly task tables will be inserted here by JavaScript -->
        </div>

        <!-- Confirmation Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-2xl">
                <h3 class="text-xl font-semibold mb-4 text-gray-800" id="modal-title">Confirm Task Claim</h3>
                <p class="text-gray-600 mb-6" id="modal-body">Are you sure you want to claim this task?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                    <button id="modal-confirm" class="px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700 transition font-semibold">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // --- Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mosque-scheduler-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Firebase Initialization ---
        setLogLevel('Debug');
        let app;
        let db;
        let auth;
        
        // --- Global State ---
        let userId = null;
        let isAuthReady = false;
        let isUIInitialized = false; // New flag to prevent UI duplication
        // Load display name from local storage for persistence
        let displayName = localStorage.getItem('userDisplayName') || null; 
        
        const NUM_WEEKS = 4;
        const NUM_TASKS = 14; 
        const BASE_COLLECTION_PATH = `/artifacts/${appId}/public/data/mosqueTasks`;
        
        // --- Task Names ---
        const TASK_NAMES_EXACT = [
            "Shopping - Boiled Eggs",
            "Shopping - Potatoes",
            "Shopping - Bread",
            "Shopping - Cheese",
            "Shopping - Vegetables",
            "Shopping - Tomatoes",
            "Shopping - Cucumbelse",
            "Cleaning 1",
            "Cleaning 2",
            "Recitation to Quran",
            "Quaran Circle Lead",
            "Reciting Doa2",
            "Reciting Doa4",
            "Reciting Doa3"
        ];
        
        // --- Date Calculation Logic (Fix for potential duplication in dates) ---
        const getNextFourThursdays = () => {
            const thursdayDates = [];
            const options = { weekday: 'short', month: 'short', day: 'numeric' };

            const today = new Date();
            let current = new Date(today);
            current.setHours(0, 0, 0, 0); // Normalize to start of day
            const targetDay = 4; // Thursday (0=Sun, 1=Mon, ..., 4=Thu)

            // 1. Calculate days until the very next Thursday
            let daysToAdd = (targetDay - current.getDay() + 7) % 7;
            
            // If today is Thursday (daysToAdd === 0), we want the one next week (7 days away)
            if (daysToAdd === 0) {
                daysToAdd = 7; 
            }

            // Set the date to the first upcoming Thursday
            current.setDate(current.getDate() + daysToAdd); 

            for (let i = 0; i < NUM_WEEKS; i++) {
                const loopDate = new Date(current);
                loopDate.setDate(current.getDate() + (i * 7)); // Add 0, 7, 14, 21 days
                
                const dateString = loopDate.toLocaleDateString('en-US', options); 
                
                thursdayDates.push({
                    weekNumber: i + 1,
                    displayDate: dateString,
                    docId: `week_${i + 1}`
                });
            }
            return thursdayDates;
        };
        
        const WEEKS_DATA = getNextFourThursdays(); // Calculate the dates once

        const statusMessageEl = document.getElementById('status-message');
        const weeksNavEl = document.getElementById('weeks-nav');
        const weeksContainerEl = document.getElementById('weeks-container');
        
        // New UI Elements for Name Input
        const nameInputContainer = document.getElementById('name-input-container');
        const nameInput = document.getElementById('name-input');
        const setNameBtn = document.getElementById('set-name-btn');
        const userDisplayEl = document.getElementById('user-display');
        const changeNameBtn = document.getElementById('change-name-btn');

        // Modal elements
        const modalEl = document.getElementById('modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalBodyEl = document.getElementById('modal-body');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalConfirmBtn = document.getElementById('modal-confirm');

        // Function to show status message
        const showStatus = (message, isError = false) => {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            statusMessageEl.classList.add(isError ? 'bg-red-100' : 'bg-yellow-100', isError ? 'text-red-800' : 'text-yellow-800');
        };

        // Function to hide status message
        const hideStatus = () => {
            statusMessageEl.classList.add('hidden');
        };

        // Helper for exponential backoff
        const withExponentialBackoff = async (fn, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    // console.warn(`API call failed. Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };
        
        // --- Authentication & Name Handlers ---

        const authenticateUser = async () => {
            // This runs the initial anonymous sign-in.
            if (!auth.currentUser) {
                try {
                    if (initialAuthToken) {
                        await withExponentialBackoff(() => signInWithCustomToken(auth, initialAuthToken));
                    } else {
                        await withExponentialBackoff(() => signInAnonymously(auth));
                    }
                } catch (error) {
                    // Log error but don't show to user, onAuthStateChanged will handle the final state.
                    console.error("Initial Authentication Error:", error);
                }
            }
        };
        
        const updateNameDisplay = () => {
            // Check if both authentication and name are set
            const canInteract = isAuthReady && userId && displayName;

            if (canInteract) {
                userDisplayEl.textContent = `Signed in as: ${displayName}`;
                userDisplayEl.classList.remove('hidden');
                nameInputContainer.classList.add('hidden');
                changeNameBtn.classList.remove('hidden');
            } else if (isAuthReady && userId) {
                // Auth ready but name missing
                userDisplayEl.classList.add('hidden');
                nameInputContainer.classList.remove('hidden');
                changeNameBtn.classList.add('hidden');
                nameInput.value = ''; // Clear input
            } else {
                // Auth not ready
                userDisplayEl.textContent = 'Connecting...';
                userDisplayEl.classList.remove('hidden');
                nameInputContainer.classList.add('hidden');
                changeNameBtn.classList.add('hidden');
            }
        };

        const handleSetName = () => {
            const name = nameInput.value.trim();
            if (name.length < 2) {
                showStatus('Please enter a name with at least 2 characters.', true);
                setTimeout(hideStatus, 3000);
                return;
            }
            
            // Set global and local storage state
            displayName = name;
            localStorage.setItem('userDisplayName', name);
            
            updateNameDisplay();
            showStatus(`Name set to: ${name}. You can now claim tasks.`, false);
            setTimeout(hideStatus, 3000);
        };
        
        const handleToggleNameInput = () => {
            displayName = null;
            localStorage.removeItem('userDisplayName');
            updateNameDisplay();
        };

        // --- Core Application Logic ---

        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                showStatus('Error: Firebase configuration is missing.', true);
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                showStatus('Authenticating user...');

                // 1. Listen for Auth State Changes
                onAuthStateChanged(auth, async (user) => {
                    userId = user ? user.uid : null;
                    isAuthReady = true;

                    // The setupUI call is now outside this listener, 
                    // preventing duplication upon subsequent auth state changes.
                    if (user) {
                        hideStatus();
                        updateNameDisplay(); // Update based on auth + local storage name
                        await ensureInitialDataAndStartListeners(); 
                    } else {
                        // Auth failed, fallback to anonymous
                        await authenticateUser();
                        updateNameDisplay();
                        await ensureInitialDataAndStartListeners();
                    }
                });

                // 2. Perform Initial Authentication attempt
                await authenticateUser();
                
                // 3. Attach event listeners for name setup
                setNameBtn.addEventListener('click', handleSetName);
                changeNameBtn.addEventListener('click', handleToggleNameInput);

                // 4. Setup UI once all global setup is complete
                setupUI();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus(`Initialization failed: ${error.message}`, true);
            }
        };

        // --- Data Management and Listeners ---

        const generateInitialTaskData = () => {
            // Generates 14 tasks using the specific names defined above
            return TASK_NAMES_EXACT.map((name, i) => ({
                name: name,
                claimedBy: null,
                claimedByName: null,
                claimedAt: null,
            }));
        };

        const ensureInitialDataAndStartListeners = async () => {
            showStatus('Checking data structure...');
            
            // Loop through all weeks to ensure data exists and set up real-time listeners
            for (const weekData of WEEKS_DATA) {
                const docRef = doc(db, BASE_COLLECTION_PATH, weekData.docId);
                
                // Set up the real-time listener for this week
                withExponentialBackoff(() => 
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            renderWeek(weekData, docSnap.data().tasks);
                        } else {
                            // If it doesn't exist, it means we need to initialize it
                            const initialData = { weekNumber: weekData.weekNumber, tasks: generateInitialTaskData() };
                            // Use setDoc to create the document if it doesn't exist
                            withExponentialBackoff(() => setDoc(docRef, initialData))
                                .catch(err => console.error(`Failed to initialize week ${weekData.docId} data:`, err));
                        }
                    }, (error) => {
                        console.error(`Error listening to week ${weekData.docId}:`, error);
                        showStatus(`Error loading ${weekData.displayDate} data: ${error.message}`, true);
                    })
                ).catch(err => console.error("Failed to set up onSnapshot:", err));
            }
            
            hideStatus();
        };

        const claimTask = async (docId, taskIndex) => {
            if (!userId || !displayName) {
                showStatus('Please set your name and ensure authentication is ready before claiming a task.', true);
                setTimeout(hideStatus, 5000);
                return;
            }

            const docRef = doc(db, BASE_COLLECTION_PATH, docId);
            
            try {
                await withExponentialBackoff(() => 
                    runTransaction(db, async (transaction) => {
                        const docSnapshot = await transaction.get(docRef);
                        if (!docSnapshot.exists()) {
                            throw new Error("Week document does not exist!");
                        }
                        
                        const tasks = docSnapshot.data().tasks;
                        const taskToUpdate = tasks[taskIndex];
                        
                        // Determine the name to save (Now using the local storage name)
                        const currentDisplayName = displayName || 'Anonymous User';

                        // Check if it's already claimed by someone else
                        if (taskToUpdate.claimedBy && taskToUpdate.claimedBy !== userId) {
                            throw new Error(`This task is already claimed by ${taskToUpdate.claimedByName || 'another user'}.`);
                        }
                        
                        // Claim the task (or unclaim if the user is clicking their own)
                        if (taskToUpdate.claimedBy === userId) {
                            // Unclaim
                            taskToUpdate.claimedBy = null;
                            taskToUpdate.claimedByName = null;
                            taskToUpdate.claimedAt = null;
                            console.log(`Task ${taskIndex+1} for ${docId} unclaimed by user ${userId}.`);
                        } else {
                            // Claim
                            taskToUpdate.claimedBy = userId;
                            taskToUpdate.claimedByName = currentDisplayName; 
                            taskToUpdate.claimedAt = serverTimestamp();
                            console.log(`Task ${taskIndex+1} for ${docId} claimed by user ${userId}.`);
                        }

                        // Update the entire tasks array in the document
                        transaction.update(docRef, { tasks: tasks });
                        return tasks;
                    })
                );
                
            } catch (error) {
                console.error("Transaction failed: ", error);
                const message = error.message.includes("already claimed") 
                    ? error.message 
                    : "Failed to update the task. Please try again.";
                showStatus(message, true);
                setTimeout(hideStatus, 5000);
            }
        };

        // --- UI Rendering and Interaction (Now only runs once due to the isUIInitialized flag) ---

        const setupUI = () => {
            if (isUIInitialized) return; 
            isUIInitialized = true; 

            // Setup Navigation and Containers (Once)
            WEEKS_DATA.forEach((weekData, index) => {
                // 1. Create Navigation Button
                const button = document.createElement('button');
                button.id = `nav-${weekData.docId}`;
                button.textContent = weekData.displayDate;
                button.className = 'px-4 py-2 rounded-lg font-semibold transition text-sm sm:text-base';
                button.onclick = () => showWeek(weekData.docId);
                weeksNavEl.appendChild(button);

                // 2. Create Table Container
                const container = document.createElement('div');
                container.id = `${weekData.docId}-container`;
                container.className = 'week-content hidden';
                container.innerHTML = `
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">Assignments for ${weekData.displayDate} (Week ${weekData.weekNumber})</h2>
                    <div id="${weekData.docId}-table" class="bg-white shadow-xl rounded-xl overflow-hidden">
                        <!-- Table content goes here -->
                    </div>
                `;
                weeksContainerEl.appendChild(container);
            });

            // Show the first week by default
            if (WEEKS_DATA.length > 0) {
                showWeek(WEEKS_DATA[0].docId);
            }
        };

        const showWeek = (docId) => {
            // Hide all content containers
            document.querySelectorAll('.week-content').forEach(el => el.classList.add('hidden'));
            // Show the selected container
            document.getElementById(`${docId}-container`).classList.remove('hidden');

            // Deactivate all nav buttons
            document.querySelectorAll('#weeks-nav button').forEach(btn => {
                btn.classList.remove('bg-green-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });
            // Activate the selected nav button
            const activeBtn = document.getElementById(`nav-${docId}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-green-600', 'text-white', 'shadow-md');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            }
        };

        const renderWeek = (weekData, tasks) => {
            const tableContainerEl = document.getElementById(`${weekData.docId}-table`);
            if (!tableContainerEl) return;
            
            // Check if user is ready to claim tasks
            const canClaim = isAuthReady && userId && displayName;

            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-green-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3 sm:w-1/4">Task</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3 sm:w-1/2">Claimed Status</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3 sm:w-1/4">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            tasks.forEach((task, index) => {
                const isClaimed = !!task.claimedBy;
                const isClaimedByMe = task.claimedBy === userId;
                
                // Display user's name if available, otherwise 'Claimed by you' or 'Claimed'
                let claimedDisplayText;
                if (isClaimedByMe) {
                    claimedDisplayText = 'Claimed by you';
                } else if (isClaimed) {
                    claimedDisplayText = task.claimedByName && task.claimedByName !== 'Anonymous User' 
                        ? `Claimed by ${task.claimedByName}` 
                        : 'Claimed by another user';
                } else {
                    claimedDisplayText = 'Available';
                }

                const claimedClass = isClaimedByMe ? 'text-blue-600 font-medium' : (isClaimed ? 'text-red-600' : 'text-gray-400');
                
                const buttonText = isClaimedByMe ? 'Unclaim' : (isClaimed ? 'Claimed' : 'Claim');
                
                // Disable if claimed by others OR if user hasn't set their name
                const isDisabledByClaim = isClaimed && !isClaimedByMe;
                const isActionDisabled = isDisabledByClaim || !canClaim; 

                const buttonClass = isClaimedByMe 
                    ? 'bg-red-500 hover:bg-red-600' 
                    : (isClaimed 
                        ? 'bg-gray-300 cursor-not-allowed' 
                        : (canClaim 
                            ? 'bg-green-500 hover:bg-green-600' 
                            : 'bg-gray-400 cursor-not-allowed'));

                tableHTML += `
                    <tr class="${isClaimedByMe ? 'bg-blue-50' : (isClaimed ? 'bg-yellow-50' : 'hover:bg-gray-50')} transition duration-150 ease-in-out">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${task.name}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                            <span class="${claimedClass} break-all">${claimedDisplayText}</span>
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button 
                                data-doc-id="${weekData.docId}" 
                                data-index="${index}" 
                                class="claim-btn w-full sm:w-auto px-4 py-1 rounded-md text-white font-semibold shadow-sm ${buttonClass} transition ${isActionDisabled ? '' : 'transform hover:scale-105'}"
                                ${isActionDisabled ? 'disabled' : ''}
                            >
                                ${buttonText}
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table></div>`;
            tableContainerEl.innerHTML = tableHTML;
        };

        // --- Event Listeners for Interaction ---

        const handleTaskAction = (event) => {
            const button = event.target.closest('.claim-btn');
            if (!button || button.disabled || !isAuthReady) return;
            
            const docId = button.dataset.docId;
            const taskIndex = parseInt(button.dataset.index);
            
            // Get the specific task name for the modal display
            const taskName = TASK_NAMES_EXACT[taskIndex];
            
            const weekData = WEEKS_DATA.find(w => w.docId === docId);
            const displayDate = weekData ? weekData.displayDate : 'Unknown Date';
            
            if (!userId || !displayName) {
                showStatus('Please set your name to claim a task.', true);
                setTimeout(hideStatus, 5000);
                return;
            }

            // Show Confirmation Modal
            modalTitleEl.textContent = button.textContent === 'Unclaim' ? 'Confirm Unclaim' : 'Confirm Task Claim';
            modalBodyEl.innerHTML = `Are you sure you want to ${button.textContent.toLowerCase()} <span class="font-bold text-green-700">${taskName}</span> for <span class="font-bold text-green-700">${displayDate}</span>?`;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');

            // Set up modal action
            modalConfirmBtn.onclick = () => {
                modalEl.classList.add('hidden');
                modalEl.classList.remove('flex');
                claimTask(docId, taskIndex);
            };

            modalCancelBtn.onclick = () => {
                modalEl.classList.add('hidden');
                modalEl.classList.remove('flex');
            };
        };

        // Attach a single delegated listener to the main container
        weeksContainerEl.addEventListener('click', handleTaskAction);

        // --- Start Application ---
        initializeFirebase();

    </script>
</body>
</html>
